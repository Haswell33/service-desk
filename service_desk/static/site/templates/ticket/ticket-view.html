{% extends 'home.html' %}
{% load filters %}
<head>
  <title>{% block title %} {{ block.super }} | Ticket {{ object.key }}{% endblock %}</title>
</head>

<body>
  {% block content_page %}
  <div id="content-page_header" class="separated">
    <div class="content-page_header-block">
      <div class="content-page_header-block_type">{{ object.type.icon_img }}</div>
      <h2>{{ object.key }}</h2>
    </div>
  </div>
  <span class="separator-horizontal"></span>
  <div class="content-page-block">
    <div id="ticket-view_navbar">
      <div class="ticket-view_navbar-block">
        <button id="button_ticket-edit" data-type="action">Edit</button>
        <div id="navbar-block_edit-dialog" class="dialog center">
          <form action="{% url 'update_ticket' object.slug %}" method="post">
            {% csrf_token %}
            <h2>Edit {{object.key}}</h2>
            <div class="form-field long-field required">
              <label for="{{ form_update.title.id_for_label }}">{{ form_update.title.label }}</label>
              {{ form_update.title }}
              <div class="description">{{ form_update.title.help_text }}</div>
            </div>
            <div class="form-field medium-field required">
              <label for="{{ form_update.priority.id_for_label }}">{{ form_update.priority.label }}</label>
              {{ form_update.priority }}
            </div>
            <div class="form-field medium-field">
              <label for="{{ form_update.labels.id_for_label }}">{{ form_update.labels.label }}</label>
              {{ form_update.labels }}
            </div>
            <div class="form-field long-field">
              <label for="{{ form_update.description.id_for_label }}">{{ form_update.description.label }}</label>
              {{ form_update.media }} {{ form_update.description }}
            </div>
            <div class="form-field long-field">
              <input type="submit" class="button" value="Save">
            </div>
          </form>
        </div>
      </div>
      <div class="ticket-view_navbar-block">
        <form action="{% url 'update_ticket_status' object.slug %}" method="post">
          {% csrf_token %}
          {% for transition in transitions %}
            <button type="submit" name="transition" value="{{ transition.id }}" data-type="action" title='Change status to "{{ transition.transition.dest_status }}"' onmouseover="this.style.background-color={{transition.transition.dest_status.color}}">
              {{ transition.transition.name }}
            </button>
          {% endfor %}
        </form>
      </div>
      <div class="ticket-view_navbar-block">
        <button id="button_ticket-assignee" data-type="action">Assign</button>
        <div id="navbar-block_assignee-dialog" class="dialog center">
          <form action="{% url 'update_ticket_assignee' object.slug %}" method="post">
            {% csrf_token %}
            <div class="form-field short-field">
              <label for="{{ form_update_assignee.assignee.id_for_label }}">{{ form_update_assignee.assignee.label }}</label>
              {{ form_update_assignee.assignee }}
            </div>
            <input type="submit" value="Save">
          </form>
        </div>
      </div>
      <div class="ticket-view_navbar-block">
        <form action="{% url 'update_ticket_suspend' object.slug %}" method="post">
          {% csrf_token %}
          {% if object.suspended %}
            <button data-type="action">Unsuspend</button>
          {% else %}
            <button data-type="action">Suspend</button>
          {% endif %}
        </form>
      </div>
    </div>
    <div id="ticket-view_content">
      <div class="ticket-view_field-group">
        <div class="ticket-view_field ticket-title">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'title' %}
          </div>
          <div class="ticket-view_field_content">
            {{ object.title }}
          </div>
        </div>
      </div>
      <div class="ticket-view_field-group main">
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'type' %}
          </div>
          <div class="ticket-view_field_content">
            {{ object.type.icon_img_text }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'status' %}
          </div>
          <div class="ticket-view_field_content">
            {{ object.status.status_color }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'labels' %}
          </div>
          <div class="ticket-view_field_content">
            {% if object.labels.count > 0 %}
              {% for label in object.labels.all %}
                <div class="label-view">
                  {{ label }}
                </div>
              {% endfor %}
            {% else %}
              <div class="ticket-block_info-left">
                None
              </div>
            {% endif %}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'reporter' %}
          </div>
          <div class="ticket-view_field_content user-view">
            {{ object.reporter_img_text }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'priority' %}
          </div>
          <div class="ticket-view_field_content">
            {{ object.priority.icon_img_text }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'assignee' %}
          </div>
          <div class="ticket-view_field_content user-view">
            {{ object.assignee_img_text }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'created' %}
          </div>
          <div class="ticket-view_field_content ticket-user">
            {{ object.created_datetime }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'updated' %}
          </div>
          <div class="ticket-view_field_content ticket-user">
            {{ object.updated_datetime }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'resolution' %}
          </div>
          <div class="ticket-view_field_content">
            {{ object.get_resolution }}
          </div>
        </div>
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'suspended' %}
          </div>
          <div class="ticket-view_field_content">
            {% if object.suspended %}
              Yes
            {% else %}
              <div class="ticket-block_info-left">
                No
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="ticket-view_field-group aside">
        <div class="ticket-view_field ticket-attachment">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'attachments' %}
          </div>
          <div class="ticket-view_field_content">
            {% if object.attachments.count > 0 %}
              {% for attachment in object.attachments.all %}
                <div class="attachment-view">
                  <a class="file {% get_file_extension_class attachment.filename %} default-hover" href="{{ MEDIA_URL }}{{ attachment.file }}" download="{{ attachment.filename }}" title="Click to download {{ attachment.filename }}"><strong style="padding-left: 5px;">{% get_max_length_string attachment.filename 60 %}</strong></a>
                  <div class="attachment-view_delete" title="Delete {{ attachment.filename }}">
                    <form action="{% url 'update_ticket_attachment_delete' object.slug  %}" method="post">
                      {% csrf_token %}
                      <input type="hidden" name="attachment" value="{{ attachment.id }}">
                      <button type="submit" class="no-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon dark default-hover" viewBox="0 0 16 16">
                          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                  <div class="description break-flex">({{ attachment.display_size }}) {{ attachment.uploaded_datetime }}</div>
                  <div class="description break-flex" style="font-style: italic">Attached by {{ attachment.user }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div class="ticket-block_info-left">
                No attachments
              </div>
            {% endif %}
            <button id="button_ticket-attachment-add" data-type="action" class="button-icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Upload file
            </button>
            <div id="navbar-block_attachment-add-dialog" class="dialog center">
              <form enctype="multipart/form-data" action="{% url 'update_ticket_attachment_add' object.slug %}" method="post">
                {% csrf_token %}
                <h2>Upload attachment/s</h2>
                <div class="form-field medium-field">
                  <label for="id_attachments">Attach a file</label>
                  <input type="file" id="id_attachments" name="attachments" multiple/>
                </div>
                <input type="submit" value="Upload">
              </form>
            </div>
            <span class="attachment-dialog-bg" style="display: none"></span>
          </div>
        </div>
      </div>
      <span class="separator-horizontal-thin"></span>
      <div class="ticket-view_field-group break-flex main maximize-height">
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'description' %}
          </div>
          <div class="ticket-view_field_content description-view">
            {{ object.description|safe }}
          </div>
        </div>
      </div>
      <div class="ticket-view_field-group aside maximize-height">
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            Relations
          </div>
          <div class="ticket-view_field_content">
            <div class="relation-view-block">
              <div class="relation-view-block-title">
                <p>Outgoing</p>
              </div>
              {% if object.relations_out.count > 0 %}
                {% for relation in object.relations_out.all %}
                  <div class="relation-view ticket-block">
                    <div class="ticket-block_row " row="1" style="border-bottom: none; padding: 0">
                      <a href="{% url 'view_ticket' relation.slug %}">
                        <div class="ticket_link">
                          {{ relation.type.icon_img }}
                          <p class="ticket-key">{{ relation.key }}</p>
                        </div>
                      </a>
                        <div class="ticket-block_row-block">
                          {{ relation.status.status_color }}
                        </div>
                    </div>
                    <div class="relation-view_delete" title="Delete {{ relation }}">
                      <form action="{% url 'update_ticket_attachment_delete' object.slug  %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="relation" value="{{ relation.id }}">
                        <button type="submit" class="no-button">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon dark default-hover" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="ticket-block_info-left">
                  No outgoing relations
                </div>
              {% endif %}
            </div>
            <div class="relation-view-block">
              <div class="relation-view-block-title">
                <p>Incoming</p>
              </div>
              {% if object.relations_in.count > 0 %}
                {% for relation in object.relations_in.all %}
                  <div class="relation-view ticket-block">
                    <div class="ticket-block_row " row="1" style="border-bottom: none; padding: 0">
                      <a href="{% url 'view_ticket' relation.slug %}">
                        <div class="ticket_link">
                          {{ relation.type.icon_img }}
                          <p class="ticket-key">{{ relation.key }}</p>
                        </div>
                      </a>
                        <div class="ticket-block_row-block">
                          {{ relation.status.status_color }}
                        </div>
                    </div>
                    <div class="relation-view_delete" title="Delete {{ relation }}">
                      <form action="{% url 'update_ticket_attachment_delete' object.slug  %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="relation" value="{{ relation.id }}">
                        <button type="submit" class="no-button">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon dark default-hover" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="ticket-block_info-left">
                  No incoming relations
                </div>
              {% endif %}
            </div>
            <button id="button_ticket-relation-add" data-type="action" class="button-icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Add relation
            </button>
            <div id="navbar-block_relation-add-dialog" class="dialog center">
              <form action="{% url 'update_ticket_relation_add' object.slug %}" method="POST">
                {% csrf_token %}
                <h2>Add relation</h2>
                <div class="form-field medium-field required">
                  <label for="id_relations">Search for open tickets</label>
                  <select id="id_relations" name="relations" multiple>
                    {% for ticket in available_tickets_to_relate %}
                      <option icon="{{ ticket.type.icon }}" value="{{ ticket.id }}">{{ ticket.key }} - {{ ticket.title }}</option>
                    {% endfor %}
                  </select>
                </div>
                <input type="submit" value="Save">
              </form>
            </div>
            <span class="relation-dialog-bg" style="display: none"></span>
          </div>
        </div>
      </div>
      <span class="separator-horizontal-thin"></span>
      <div class="ticket-view_field-group break-flex ">
        <div class="ticket-view_field">
          <div class="ticket-view_field_label">
            {% get_verbose_name object 'comments' %}
          </div>
          <div class="ticket-view_field_content">
            {% if object.comments.count > 0 %}
              {% for attachment in object.comments.all %}
                <div class="comment-view">
                </div>
              {% endfor %}
            {% else %}
              <div class="ticket-block_info-left">
                No comments
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% if messages %}
      {% for message in messages %}
        <div class="message {{ message.tags }}">
          {{ message|safe }}
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <script>
    $(document).ready(function(){renderFields('ticket-view', '{{ MEDIA_URL }}')})
  </script>
  {% endblock %}
</body>


